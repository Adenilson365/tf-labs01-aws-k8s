name: pr-submit
on:
  pull_request:
    branches:
      - main
      - dev
jobs:
    tf_plan:
        uses: Adenilson365/tf-labs01-aws-k8s/.github/workflows/terraform-plan.yml@main
        secrets: inherit
    pr_submit:
        needs: tf_plan
        runs-on: ubuntu-latest
        permissions:
          pull-requests: write
          issues: write
        steps:
            - name: Checkout Reposit칩rio
              uses: actions/checkout@v4
            
            - name: Download Plan
              uses: actions/download-artifact@v4
              with:
                name: tfplan-${{ github.ref_name == 'main' && 'prod' || 'dev' }}
            
            - name: Verificar Plan
              run: cat plan.txt 

            - name: Resumo do Plano
              run: |
                echo "Resumo do plano"
                cat plan.txt | grep "Plan:" || exit 0
                echo "===================================================================================================="
                echo "Recursos a serem destru칤dos"  
                cat plan.txt | grep "will be destroyed" || echo "Nenhum recurso ser치 destru칤do"
                echo "===================================================================================================="
                echo "Recursos a serem modificados"
                cat plan.txt | grep "will be changed" || echo "Nenhum recurso ser치 alterado"
                echo "===================================================================================================="
                echo "Recursos a serem criados"
                cat plan.txt | grep "will be created" || echo "Nenhum recurso ser치 criado"

            - name: Comentar PR
              uses: actions/github-script@v7
              with:
                script: |
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: '游녦 Thanks for reporting!
                    echo "Resumo do plano"
                    cat plan.txt | grep "Plan:" || exit 0 "
                    echo "===================================================================================================="
                    echo "Recursos a serem destru칤dos"  
                    cat plan.txt | grep "will be destroyed" || echo "Nenhum recurso ser치 destru칤do"
                    echo "===================================================================================================="
                    echo "Recursos a serem modificados"
                    cat plan.txt | grep "will be changed" || echo "Nenhum recurso ser치 alterado"
                    echo "===================================================================================================="
                    echo "Recursos a serem criados"
                    cat plan.txt | grep "will be created" || echo "Nenhum recurso ser치 criado" '
                  })
          


    